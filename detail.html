<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Dataset - Pa'lintasang Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="lib/db.js"></script>
    <script src="lib/helpers.js"></script>
    <script src="lib/config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .hero-gradient { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); }
        .accent-makassar { color: #facc15; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-slate-200">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <a href="index.html" class="flex items-center space-x-2">
                    <div class="bg-blue-900 p-1.5 rounded-lg">
                        <i class="fas fa-route text-white text-lg"></i>
                    </div>
                    <h1 class="font-bold text-lg tracking-tight text-blue-900 uppercase">PA'LINTASANG <span class="text-amber-500">DATA</span></h1>
                </a>
            </div>
            <div class="hidden lg:flex space-x-6 font-medium text-xs">
                <a href="index.html" class="hover:text-blue-600 transition">Beranda</a>
                <a href="katalog.html" class="text-blue-600 font-bold">Katalog</a>
                <a href="index.html" class="hover:text-blue-600 transition">Visualisasi</a>
            </div>
            <div id="authArea"></div>
        </div>
    </nav>

    <header class="hero-gradient text-white py-12 relative overflow-hidden">
        <div class="container mx-auto px-6 relative z-10">
            <div class="flex items-center space-x-2 text-[10px] font-bold uppercase tracking-widest opacity-60 mb-4">
                <a href="katalog.html" class="hover:text-amber-400">Katalog</a>
                <span>/</span>
                <span class="text-amber-400">Lalu Lintas</span>
            </div>
            <h2 id="detailTitle" class="text-3xl md:text-4xl font-extrabold italic uppercase leading-tight mb-4">
                Data Volume Lalu Lintas <br><span id="detailAccent" class="accent-makassar">Jalan Kota Makassar 2022</span>
            </h2>
            <div class="flex flex-wrap gap-4 text-xs">
                <span id="detailUpdate" class="flex items-center"><i class="far fa-calendar-check mr-2 text-amber-400"></i> Update: 15 Okt 2022</span>
                <span id="detailRows" class="flex items-center"><i class="fas fa-database mr-2 text-amber-400"></i> 12,450 Baris</span>
            </div>
        </div>
        <div class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -mr-20 -mt-20 blur-3xl"></div>
    </header>

    <main class="container mx-auto px-6 py-10">
        <div class="flex flex-col lg:flex-row gap-8">
            
            <div class="w-full lg:w-2/3 space-y-8">
                
                <section class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <h3 class="text-lg font-extrabold text-blue-900 mb-4 uppercase tracking-tight flex items-center">
                        <span class="w-8 h-1 bg-amber-500 rounded-full mr-3"></span> Deskripsi Dataset
                    </h3>
                    <p id="detailDesc" class="text-slate-600 text-sm leading-relaxed mb-6">
                        Dataset ini berisi informasi volume lalu lintas pada ruas-ruas jalan utama di Kota Makassar selama tahun 2022. Data dikumpulkan melalui sistem penghitung kendaraan otomatis yang dipasang di 25 titik pemantauan strategis. Dataset mencakup jumlah kendaraan berdasarkan kategori (motor, mobil penumpang, angkutan umum, truk) serta waktu pengambilan data (jam sibuk pagi, siang, dan sore).
                    </p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Format</p>
                            <p id="metaFormat" class="text-sm font-bold text-blue-900">CSV, XLS, JSON</p>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Update</p>
                            <p id="metaUpdate" class="text-sm font-bold text-blue-900">Triwulan</p>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Ukuran</p>
                            <p id="metaSize" class="text-sm font-bold text-blue-900">4.2 MB</p>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Status</p>
                            <p id="metaStatus" class="text-sm font-bold text-emerald-600 italic">Terverifikasi</p>
                        </div>
                    </div>
                </section>

                <section class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-extrabold text-blue-900 uppercase tracking-tight flex items-center">
                            <span class="w-8 h-1 bg-amber-500 rounded-full mr-3"></span> Preview Data
                        </h3>
                        <span class="text-[10px] font-bold text-slate-400 italic">Menampilkan 5 Baris Pertama</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs border-collapse">
                            <thead>
                                <tr class="bg-blue-900 text-white">
                                    <th class="p-3 rounded-tl-xl font-bold uppercase tracking-tighter">Lokasi Jalan</th>
                                    <th class="p-3 font-bold uppercase tracking-tighter">Motor</th>
                                    <th class="p-3 font-bold uppercase tracking-tighter">Mobil</th>
                                    <th class="p-3 font-bold uppercase tracking-tighter">Truk/Bus</th>
                                    <th class="p-3 rounded-tr-xl font-bold uppercase tracking-tighter">Total</th>
                                </tr>
                            </thead>
                            <tbody id="previewBody" class="text-slate-600">
                                <tr><td colspan="5" class="p-4 text-slate-400 italic">Pratinjau tidak tersedia untuk dataset ini.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <div class="w-full lg:w-1/3 space-y-6">
                
                <div class="bg-blue-900 p-8 rounded-[2.5rem] text-white shadow-xl shadow-blue-900/20">
                    <h4 class="font-extrabold uppercase text-xs tracking-[0.2em] mb-6 text-amber-400">Unduh Dataset</h4>
                    <div class="space-y-3">
                        <button id="downloadCsv" class="w-full bg-white/10 hover:bg-amber-500 hover:text-blue-900 p-4 rounded-2xl flex items-center justify-between transition group">
                            <span class="text-xs font-bold uppercase tracking-widest">File Format CSV</span>
                            <i class="fas fa-download text-sm group-hover:scale-125 transition"></i>
                        </button>
                        <button id="downloadJson" class="w-full bg-white/10 hover:bg-amber-500 hover:text-blue-900 p-4 rounded-2xl flex items-center justify-between transition group">
                            <span class="text-xs font-bold uppercase tracking-widest">File Format JSON</span>
                            <i class="fas fa-file-code text-sm"></i>
                        </button>
                        <button id="downloadXls" class="w-full bg-white/10 hover:bg-amber-500 hover:text-blue-900 p-4 rounded-2xl flex items-center justify-between transition group">
                            <span class="text-xs font-bold uppercase tracking-widest">File Format XLS</span>
                            <i class="fas fa-file-excel text-sm"></i>
                        </button>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <h4 class="font-extrabold uppercase text-xs tracking-widest mb-6 text-blue-900">Informasi Metadata</h4>
                    <div class="space-y-4">
                        <div>
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">ID Dataset</p>
                            <p id="datasetId" class="text-xs font-bold text-slate-700">DISHUB-MKS-TRF-2022-001</p>
                        </div>
                        <div>
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Penanggung Jawab</p>
                            <p id="datasetOwner" class="text-xs font-bold text-slate-700">Bidang Lalu Lintas</p>
                        </div>
                        <div>
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Kata Kunci</p>
                            <div class="flex flex-wrap gap-2 mt-2">
                                <span class="px-2 py-1 bg-slate-100 rounded text-[9px] font-bold text-slate-500 uppercase">Volume</span>
                                <span class="px-2 py-1 bg-slate-100 rounded text-[9px] font-bold text-slate-500 uppercase">Transportasi</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-16">
            <h3 class="text-xl font-extrabold text-blue-900 mb-8 uppercase italic tracking-tighter">
                Dataset <span class="text-amber-500">Terkait</span>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-3xl border border-slate-100 hover:border-amber-400 transition-all shadow-sm group">
                    <span class="text-[9px] font-black text-blue-600 bg-blue-50 px-2 py-1 rounded mb-3 inline-block uppercase">Angkutan</span>
                    <h4 class="font-bold text-sm text-blue-900 mb-2 leading-tight group-hover:text-blue-600">Data Rute Angkutan Umum Kota Makassar</h4>
                    <p class="text-slate-400 text-[10px] line-clamp-2 italic mb-4">Informasi lengkap rute pete-pete, bus kota, dan BRT.</p>
                    <a href="detail.html" class="text-amber-600 text-[10px] font-black uppercase tracking-widest hover:mr-2 transition-all">Lihat Detail <i class="fas fa-arrow-right ml-1"></i></a>
                </div>
                <div class="bg-white p-6 rounded-3xl border border-slate-100 hover:border-amber-400 transition-all shadow-sm group">
                    <span class="text-[9px] font-black text-purple-600 bg-purple-50 px-2 py-1 rounded mb-3 inline-block uppercase">Infrastruktur</span>
                    <h4 class="font-bold text-sm text-blue-900 mb-2 leading-tight group-hover:text-blue-600">Data Lampu Lalu Lintas Makassar</h4>
                    <p class="text-slate-400 text-[10px] line-clamp-2 italic mb-4">Lokasi dan kondisi teknis lampu lalin persimpangan.</p>
                    <a href="detail.html" class="text-amber-600 text-[10px] font-black uppercase tracking-widest hover:mr-2 transition-all">Lihat Detail <i class="fas fa-arrow-right ml-1"></i></a>
                </div>
                <div class="bg-white p-6 rounded-3xl border border-slate-100 hover:border-amber-400 transition-all shadow-sm group">
                    <span class="text-[9px] font-black text-rose-600 bg-rose-50 px-2 py-1 rounded mb-3 inline-block uppercase">Lalu Lintas</span>
                    <h4 class="font-bold text-sm text-blue-900 mb-2 leading-tight group-hover:text-blue-600">Statistik Kecelakaan Lalin 2022</h4>
                    <p class="text-slate-400 text-[10px] line-clamp-2 italic mb-4">Data tingkat keparahan dan sebaran titik kecelakaan.</p>
                    <a href="detail.html" class="text-amber-600 text-[10px] font-black uppercase tracking-widest hover:mr-2 transition-all">Lihat Detail <i class="fas fa-arrow-right ml-1"></i></a>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-blue-950 text-white pt-16 pb-10 mt-20">
        <div class="container mx-auto px-6 text-center">
            <h4 class="font-bold text-lg mb-6 tracking-widest uppercase">PA'LINTASANG <span class="text-amber-500">DATA</span></h4>
            <div class="h-[1px] bg-white/10 w-full mb-8"></div>
            <p class="text-[10px] text-white/40 uppercase tracking-[0.3em]">Â© 2025 PKL STATISTIKA UNM  | Data Driven Policy</p>
        </div>
    </footer>

    <script>
        (function(){
            function getParam(name){
                return new URLSearchParams(window.location.search).get(name);
            }

            function findInMock(id){
                // small mock fallback
                const mock = [
                    { id: '0', title: 'Analisis Volume Kendaraan Titik 1', category: 'Lalu Lintas', format: 'CSV', year: '2024', date: '10 Des 2024', desc: 'Contoh dataset mock', rows: 12450 },
                    { id: '1', title: 'Trayek Angkutan Kota Jalur 1', category: 'Transportasi', format: 'JSON', year: '2023', date: '05 Nov 2023', desc: 'Contoh dataset mock 2', rows: 5320 }
                ];
                return mock.find(d => d.id == id) || null;
            }

            function renderTableFromArray(arr){
                if (!arr || !arr.length) return;
                const table = document.getElementById('previewBody').closest('table');
                const thead = table.querySelector('thead');
                const headers = arr[0];
                thead.innerHTML = `<tr class="bg-blue-900 text-white">${headers.map(h => `<th class="p-3 font-bold uppercase tracking-tighter">${h || ''}</th>`).join('')}</tr>`;
                const body = document.getElementById('previewBody');
                body.innerHTML = arr.slice(1).map(r => `<tr class="border-b border-slate-50 hover:bg-slate-50">${r.map(c => `<td class="p-3">${c}</td>`).join('')}</tr>`).join('');
            }

            function populate(item){
                if(!item) return;
                document.getElementById('detailTitle').innerHTML = item.title;
                if (document.getElementById('detailAccent')) document.getElementById('detailAccent').innerText = item.title;
                document.getElementById('detailDesc').innerText = item.desc || '';
                document.getElementById('datasetId').innerText = item.id || '';
                document.getElementById('datasetOwner').innerText = item.owner || 'Pengunggah';
                document.getElementById('metaFormat').innerText = item.format || 'CSV';
                document.getElementById('metaUpdate').innerText = item.update || (item.date || '');
                document.getElementById('metaSize').innerText = item.size || '-';
                document.getElementById('metaStatus').innerText = item.status || 'Terverifikasi';
                document.getElementById('detailUpdate').innerText = 'Update: ' + (item.date || '');
                document.getElementById('detailRows').innerText = (item.rows ? item.rows.toLocaleString() : '-') + ' Baris';
                // If original file data exists, parse and render full sheet; else use saved preview
                if (item.fileData) {
                    try {
                        const dataUrl = item.fileData;
                        const base64 = dataUrl.split(',')[1];
                        const wb = XLSX.read(base64, { type: 'base64' });
                        const first = wb.SheetNames[0];
                        const ws = wb.Sheets[first];
                        const arr = XLSX.utils.sheet_to_json(ws, { header: 1 });
                        if (arr && arr.length) renderTableFromArray(arr);
                    } catch (err) {
                        console.error('Gagal parse fileData untuk preview', err);
                        if (item.preview) renderTableFromArray(item.preview);
                    }
                } else if (item.preview) {
                    renderTableFromArray(item.preview);
                }
            }

            const id = getParam('id') || getParam('added');
            let dataset = null;

            // Prefer Apps Script (Google Sheets) then fallback to local storage / getAllDatasets()
            const { GOOGLE_SCRIPT_URL, API_KEY } = (window.APP_CONFIG || {});
            if (!GOOGLE_SCRIPT_URL) console.warn('GOOGLE_SCRIPT_URL not configured. Set lib/config.js');

            async function fetchFromAppsScript(id){
                try{
                    const res = await fetch(`${GOOGLE_SCRIPT_URL}?method=getDataset&api_key=${API_KEY}&id=${encodeURIComponent(id)}`);
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    const json = await res.json();
                    if (json && json.id) return json;
                }catch(e){ console.warn('AppsScript fetch failed', e); }
                return null;
            }

            // Adapter so existing populate() is used by the new flow
            function populateDetailPage(d){
                if (!d) return;
                dataset = d;
                populate(d);
                const params = new URLSearchParams(window.location.search);
                if (params.get('download') === '1' && dataset && dataset.file_url) {
                    window.location.href = dataset.file_url;
                }
            }

            async function loadDatasetDetail(id){
                if (!id) return;
                try {
                    // Try Google Apps Script first
                    const ds = await fetchFromAppsScript(id);
                    if (ds) {
                        populateDetailPage(ds);
                        return;
                    }
                } catch (error) {
                    console.warn('Failed to load from Google Sheet:', error);
                }

                // Fallback to local datasets (prefer getAllDatasets if provided)
                try {
                    let localDatasets = [];
                    if (typeof getAllDatasets === 'function') {
                        localDatasets = await getAllDatasets();
                    } else {
                        const raw = localStorage.getItem('userDatasets');
                        localDatasets = raw ? JSON.parse(raw) : [];
                    }
                    const found = localDatasets.find(d => d.id == id);
                    if (found) {
                        populateDetailPage(found);
                        return;
                    }
                } catch (e) {
                    console.warn('Failed to load from local storage:', e);
                }

                // Last resort: mock
                const mockData = findInMock(id);
                if (mockData) {
                    populateDetailPage(mockData);
                } else {
                    document.getElementById('detailTitle').innerHTML = 'Dataset tidak ditemukan';
                }
            }

            // Panggil fungsi ini ketika halaman detail dimuat
            const urlParams = new URLSearchParams(window.location.search);
            const datasetId = urlParams.get('id') || urlParams.get('added');
            if (datasetId) loadDatasetDetail(datasetId);

            // Download button helpers (export minimal CSV/JSON/XLSX using simple conversion)
            function downloadText(filename, content, mime){
                const blob = new Blob([content], { type: mime || 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
            }

            function dataURLtoBlob(dataurl){
                const arr = dataurl.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8 = new Uint8Array(n);
                while(n--) u8[n] = bstr.charCodeAt(n);
                return new Blob([u8], { type: mime });
            }

            document.getElementById('downloadJson').addEventListener('click', ()=>{
                if (!dataset) return alert('Tidak ada data untuk diunduh.');
                // If original file available, provide original as JSON fallback too
                if (dataset.fileData && dataset.originalName && dataset.originalName.toLowerCase().endsWith('.json')){
                    const blob = dataURLtoBlob(dataset.fileData);
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = dataset.originalName; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                } else {
                    downloadText((dataset.title||'dataset') + '.json', JSON.stringify(dataset, null, 2), 'application/json');
                }
            });

            document.getElementById('downloadCsv').addEventListener('click', ()=>{
                if (!dataset) return alert('Tidak ada data untuk diunduh.');
                if (dataset.fileData && dataset.originalName){
                    // if original is csv or xlsx, prefer original
                    const blob = dataURLtoBlob(dataset.fileData);
                    const url = URL.createObjectURL(blob);
                    const suggested = dataset.originalName || ((dataset.title||'dataset') + '.csv');
                    const a = document.createElement('a'); a.href = url; a.download = suggested; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                    return;
                }
                // try to convert preview to csv
                if (dataset.preview && dataset.preview.length){
                    const csv = dataset.preview.map(r => r.map(c => `"${(''+c).replace(/"/g,'""')}"`).join(',')).join('\n');
                    downloadText((dataset.title||'dataset') + '.csv', csv, 'text/csv');
                } else {
                    downloadText((dataset.title||'dataset') + '.csv', '', 'text/csv');
                }
            });

            document.getElementById('downloadXls').addEventListener('click', ()=>{
                if (!dataset) return alert('Tidak ada data untuk diunduh.');
                if (dataset.fileData && dataset.originalName){
                    const blob = dataURLtoBlob(dataset.fileData);
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = dataset.originalName; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                    return;
                }
                // fallback: export JSON with .xls extension
                downloadText((dataset.title||'dataset') + '.xls', JSON.stringify(dataset), 'application/vnd.ms-excel');
            });

        })();
    </script>

    <script>
        (function updateAuthArea(){
            const auth = document.getElementById('authArea');
            const display = localStorage.getItem('pd_display');
            if (!auth) return;
            if (display) {
                auth.innerHTML = `<div class="flex items-center space-x-3"><div class="text-sm font-bold text-black">${display}</div><a href="dashboard.html" class="ml-3 bg-blue-900 text-white px-3 py-1 rounded-full text-xs">Dashboard</a></div>`;
            } else {
                auth.innerHTML = `<a href="login.html" class="bg-blue-900 text-white px-5 py-2 rounded-full text-xs font-bold hover:bg-amber-500 transition shadow-lg shadow-blue-900/20">Login</a>`;
            }
        })();
    </script>
</body>
</html>