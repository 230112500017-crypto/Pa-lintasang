<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Internal - Pa'lintasang Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="lib/db.js"></script>
    <script src="lib/helpers.js"></script>
    <script src="lib/config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .hero-gradient { background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%); }
        .drop-zone--over { border-color: #facc15 !important; background: rgba(250, 204, 21, 0.05); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-900 p-2 rounded-xl shadow-lg shadow-blue-900/20">
                    <i class="fas fa-user-shield text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="font-bold text-sm tracking-tight text-blue-900 uppercase leading-none">Portal Internal</h1>
                    <span id="userRole" class="text-[10px] text-amber-600 font-bold tracking-widest uppercase">Admin Dishub Makassar</span>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right hidden md:block">
                    <p id="userFullName" class="text-xs font-bold text-slate-700">Admin Dishub Makassar</p>
                    <p id="userNip" class="text-[9px] text-slate-400 font-medium">NIP. -</p>
                </div>
                <img id="userAvatar" src="https://ui-avatars.com/api/?name=Admin+Dishub&background=1e3a8a&color=fff" class="w-10 h-10 rounded-full border-2 border-white shadow-md">
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-6 py-10">
        <div class="mb-10">
            <h2 class="text-2xl font-extrabold text-blue-900 uppercase italic tracking-tighter mb-2">Manajemen <span class="text-amber-500">Upload Dataset</span></h2>
            <p class="text-slate-500 text-sm">Silakan pilih file Excel atau tempel (copy-paste) data langsung ke tabel di bawah.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                    <h3 class="text-xs font-black uppercase tracking-widest text-blue-900 mb-6 flex items-center">
                        <i class="fas fa-file-import mr-2 text-amber-500"></i> Sumber Data
                    </h3>
                    
                    <div id="dropZone" class="border-2 border-dashed border-slate-200 rounded-[1.5rem] p-8 text-center hover:border-blue-400 transition-all cursor-pointer bg-slate-50/50 group">
                        <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls, .csv">
                        <div class="bg-white w-12 h-12 rounded-2xl shadow-sm flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition">
                            <i class="fas fa-cloud-upload-alt text-blue-600"></i>
                        </div>
                        <p class="text-[11px] font-bold text-slate-600 uppercase mb-1">Klik atau seret file</p>
                        <p class="text-[9px] text-slate-400">Mendukung .XLSX, .XLS, .CSV</p>
                    </div>

                    <div class="mt-6 space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 block">Judul Dataset</label>
                            <input id="datasetTitle" type="text" placeholder="Contoh: Data Parkir Jan 2024" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-xs outline-none focus:border-blue-500 transition">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 block">Deskripsi Singkat</label>
                            <textarea id="datasetDesc" placeholder="Deskripsikan isi dataset singkat (kolom penting, sumber, catatan)." class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-xs outline-none focus:border-blue-500 transition" rows="3"></textarea>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 block">Kategori</label>
                            <select id="datasetCategory" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-xs outline-none focus:border-blue-500 font-medium">
                                <option>Lalu Lintas</option>
                                <option>Transportasi Umum</option>
                                <option>Perizinan</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 block">Tahun Data</label>
                            <select id="datasetYear" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-xs outline-none focus:border-blue-500 font-medium">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                                <option value="2021">2021</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button id="publishBtn" class="w-full bg-blue-900 text-white py-4 rounded-[1.5rem] text-xs font-bold uppercase tracking-widest hover:bg-amber-500 hover:text-blue-900 transition-all shadow-xl shadow-blue-900/20 active:scale-95">
                    <i class="fas fa-paper-plane mr-2"></i> Publikasikan Dataset
                </button>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden flex flex-col h-full">
                    <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                        <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400">
                            Pratinjau Data <span class="ml-2 text-blue-600" id="rowCount">(0 Baris)</span>
                        </h3>
                        <button onclick="clearTable()" class="text-[10px] font-bold text-rose-500 hover:underline">Hapus Semua</button>
                    </div>
                    
                    <div class="overflow-auto max-h-[500px]" id="tableContainer">
                        <table class="w-full text-left text-xs border-collapse">
                            <thead class="bg-white sticky top-0 z-10">
                                <tr id="tableHeader" class="border-b border-slate-100">
                                    <th class="p-4 text-slate-300 italic font-medium">Data akan muncul di sini setelah upload...</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="text-slate-600 divide-y divide-slate-50">
                                </tbody>
                        </table>
                    </div>

                    <div class="p-4 bg-amber-50 border-t border-amber-100 flex items-center">
                        <i class="fas fa-info-circle text-amber-500 mr-3"></i>
                        <p class="text-[10px] text-amber-700 font-medium italic">Tips: Anda bisa menyalin sel dari Excel (Ctrl+C) dan menekan (Ctrl+V) di area halaman ini untuk input cepat.</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        const rowCountText = document.getElementById('rowCount');

        // Handle File Click
        dropZone.addEventListener('click', () => fileInput.click());

        // Handle Drop File
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drop-zone--over');
        });

        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drop-zone--over'));

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drop-zone--over');
            if (e.dataTransfer.files.length) {
                processFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) processFile(e.target.files[0]);
        });

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheet];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                populateTable(jsonData);
            };
            reader.readAsArrayBuffer(file);
        }

        function populateTable(data) {
            if (data.length === 0) return;

            // Render Header
            const headers = data[0];
            tableHeader.innerHTML = headers.map(h => `<th class="p-4 font-extrabold text-blue-900 uppercase tracking-tighter bg-slate-50">${h || ''}</th>`).join('');

            // Render Body
            const rows = data.slice(1);
            tableBody.innerHTML = rows.map(row => `
                <tr class="hover:bg-blue-50/30 transition-colors">
                    ${row.map(cell => `<td class="p-4 border-b border-slate-50 font-medium">${cell || '-'}</td>`).join('')}
                </tr>
            `).join('');

            rowCountText.innerText = `(${rows.length} Baris Detected)`;
        }

        function clearTable() {
            tableHeader.innerHTML = '<th class="p-4 text-slate-300 italic font-medium">Data akan muncul di sini setelah upload...</th>';
            tableBody.innerHTML = '';
            rowCountText.innerText = '(0 Baris)';
            fileInput.value = '';
        }

        // Fitur Copy-Paste dari Excel
        document.addEventListener('paste', (e) => {
            const pasteData = e.clipboardData.getData('text');
            const rows = pasteData.split('\n').map(row => row.split('\t'));
            
            if (rows.length > 0 && rows[0].length > 1) {
                populateTable(rows);
            }
        });
    </script>
    <script>
        // Populate header with logged-in user info stored in localStorage
        (function(){
            const display = localStorage.getItem('pd_display');
            const username = localStorage.getItem('pd_username');
            const userRole = document.getElementById('userRole');
            const userFullName = document.getElementById('userFullName');
            const userNip = document.getElementById('userNip');
            const userAvatar = document.getElementById('userAvatar');

            if (display) {
                if (userRole) userRole.textContent = display;
                if (userFullName) {
                    userFullName.textContent = display;
                    userFullName.classList.remove('text-slate-700');
                    userFullName.classList.add('text-black');
                }
                if (userNip) userNip.textContent = username ? `NIP. ${username}` : 'NIP. -';
                if (userAvatar) {
                    const nameForAvatar = encodeURIComponent(display.replace(/\s+/g, '+'));
                    userAvatar.src = `https://ui-avatars.com/api/?name=${nameForAvatar}&background=1e3a8a&color=fff`;
                }
            }
        })();
    </script>

    <script>
        // Publish dataset functionality
        (function(){
            const publishBtn = document.getElementById('publishBtn');
            const titleEl = document.getElementById('datasetTitle');
            const descEl = document.getElementById('datasetDesc');
            const catEl = document.getElementById('datasetCategory');
            const yearEl = document.getElementById('datasetYear');

            publishBtn.addEventListener('click', async () => {
                // Validate input
                const title = titleEl.value.trim();
                const description = descEl.value.trim();
                const category = catEl.value;
                const year = yearEl.value;
                const selectedFile = fileInput.files[0];

                if (!title) {
                    alert('âŒ Judul dataset wajib diisi!');
                    titleEl.focus();
                    return;
                }

                // Get table data
                const tableData = getTableData();

                if (!selectedFile && (!tableData.headers || tableData.totalRows === 0)) {
                    alert('âŒ Tidak ada data untuk dipublikasikan!\nMohon upload file atau input data di tabel.');
                    return;
                }

                // Prepare dataset object
                const dataset = {
                    id: 'ds-' + Date.now(),
                    title: title,
                    description: description,
                    category: category,
                    year: year,
                    format: selectedFile ? selectedFile.name.split('.').pop().toUpperCase() : 'CSV',
                    rows: tableData.totalRows,
                    owner: localStorage.getItem('pd_display') || 'Unknown User',
                    upload_date: new Date().toISOString(),
                    status: 'pending',
                    preview_data: tableData.headers ? [tableData.headers, ...tableData.rows] : null
                };

                try {
                    // If file is selected, process it for direct upload
                    if (selectedFile) {
                        if (!isValidFile(selectedFile)) return;

                        // Convert file to base64 for storage
                        const reader = new FileReader();
                        await new Promise((resolve, reject) => {
                            reader.onload = resolve;
                            reader.onerror = reject;
                            reader.readAsDataURL(selectedFile);
                        });

                        dataset.fileData = reader.result;
                        dataset.original_filename = selectedFile.name;
                        dataset.file_size = selectedFile.size;
                        dataset.format = selectedFile.name.split('.').pop().toUpperCase();
                    }

                    // Send data directly to Google Sheets
                    alert('ðŸ“¤ Mengirim data ke Google Sheets...');
                    const sheetsResult = await uploadToGoogleSheets(dataset);

                    if (sheetsResult && sheetsResult.success) {
                        // Save to IndexedDB for public access
                        await saveDataset(dataset);

                        // Success message
                        const successMessage = `
âœ… **DATASET BERHASIL DIPUBLIKASIKAN!**

Judul: ${title}
Kategori: ${category}
Tahun: ${year}
ID: ${dataset.id}

Data telah disimpan ke:
â€¢ Google Sheets âœ“
â€¢ Database publik âœ“

Data akan muncul di halaman dataset dalam beberapa detik.
                        `;

                        alert(successMessage);

                        // Reset form
                        clearTable();
                        titleEl.value = '';
                        descEl.value = '';
                        fileInput.value = '';

                        // Redirect to Datasets page
                        setTimeout(() => {
                            window.location.href = `Datasets.html?added=${encodeURIComponent(dataset.id)}`;
                        }, 2000);

                    } else {
                        throw new Error('Gagal mengirim ke Google Sheets');
                    }

                } catch (error) {
                    console.error('Publish failed:', error);

                    // Fallback: Save to IndexedDB only
                    await saveDataset(dataset);

                    const fallbackMessage = `
âš ï¸ **GOOGLE SHEETS OFFLINE - DISIMPAN LOKAL**

Data berhasil disimpan di database lokal:
ID: ${dataset.id}

Catatan: Data tersimpan dan dapat diakses publik.
Untuk sinkronisasi ke Google Sheets, coba lagi nanti.
                    `;

                    alert(fallbackMessage);

                    // Reset form
                    clearTable();
                    titleEl.value = '';
                    descEl.value = '';

                    // Redirect to Datasets page
                    setTimeout(() => {
                        window.location.href = `Datasets.html?added=${encodeURIComponent(dataset.id)}`;
                    }, 1500);
                }
            });
        })();
// Fungsi untuk upload ke Google Spreadsheet
async function uploadToGoogleSheets(datasetData) {
  const { GOOGLE_SCRIPT_URL, API_KEY } = window.APP_CONFIG || {};
  
  if (!GOOGLE_SCRIPT_URL || !API_KEY) {
    console.error('Google Script URL atau API Key belum diatur di lib/config.js');
    return null;
  }
  
  try {
    const payload = {
      method: 'addDataset',
      api_key: API_KEY,
      ...datasetData
    };
    
    console.log('Mengirim data ke Google Sheets:', payload);
    
    // Kirim ke Google Apps Script
    const response = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors', // Penting untuk Google Apps Script
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload)
    });
    
    // Karena no-cors, kita tidak bisa membaca response
    // Tapi kita anggap sukses jika tidak ada error
    return { success: true, message: 'Data terkirim ke Google Sheets' };
    
  } catch (error) {
    console.error('Error mengirim ke Google Sheets:', error);
    throw error;
  }
}

// Fungsi untuk upload file ke Google Drive (manual)
function uploadFileToDriveManual(file) {
  return new Promise((resolve, reject) => {
    const instructions = `
ðŸ“ **UPLOAD FILE KE GOOGLE DRIVE**

Langkah-langkah:
1. Buka drive.google.com
2. Upload file: "${file.name}"
3. Klik kanan file â†’ "Dapatkan link"
4. Setel akses: "Anyone with the link" â†’ "Viewer"
5. Salin link dan tempel di popup berikut

Catatan: File akan tersimpan di Google Drive.
    `;
    
    alert(instructions);
    
    const driveLink = prompt('ðŸ“‹ Tempel Google Drive link di sini:', '');
    
    if (driveLink) {
      // Konversi share link ke direct download link
      let directLink = driveLink;
      
      // Pattern 1: https://drive.google.com/file/d/FILE_ID/view
      const pattern1 = /\/d\/([a-zA-Z0-9_-]+)/;
      // Pattern 2: https://drive.google.com/open?id=FILE_ID
      const pattern2 = /id=([a-zA-Z0-9_-]+)/;
      
      if (pattern1.test(driveLink)) {
        const fileId = driveLink.match(pattern1)[1];
        directLink = `https://drive.google.com/uc?export=download&id=${fileId}`;
      } else if (pattern2.test(driveLink)) {
        const fileId = driveLink.match(pattern2)[1];
        directLink = `https://drive.google.com/uc?export=download&id=${fileId}`;
      }
      
      resolve({
        share_link: driveLink,
        direct_link: directLink,
        filename: file.name,
        size: file.size
      });
    } else {
      reject(new Error('User membatalkan upload'));
    }
  });
}

// Fungsi untuk simpan ke localStorage (backup)
function saveToLocalBackup(dataset) {
  try {
    const localData = JSON.parse(localStorage.getItem('local_datasets') || '[]');
    
    // Tambah ID unik jika belum ada
    if (!dataset.id) {
      dataset.id = 'local-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    }
    
    dataset.local_backup = true;
    dataset.local_save_date = new Date().toISOString();
    
    localData.push(dataset);
    localStorage.setItem('local_datasets', JSON.stringify(localData));
    
    console.log('Data disimpan ke localStorage backup:', dataset);
    return dataset.id;
  } catch (error) {
    console.error('Gagal simpan ke localStorage:', error);
    return null;
  }
}

// Fungsi untuk ambil data dari tabel
function getTableData() {
  const headers = Array.from(tableHeader.querySelectorAll('th'))
    .map(th => th.textContent.trim())
    .filter(h => h && h !== 'Data akan muncul di sini setelah upload...');
  
  const rows = Array.from(tableBody.querySelectorAll('tr'))
    .map(tr => Array.from(tr.querySelectorAll('td'))
      .map(td => td.textContent.trim())
    )
    .filter(row => row.length > 0);
  
  return {
    headers: headers.length > 0 ? headers : null,
    rows: rows.length > 0 ? rows : null,
    totalRows: rows.length
  };
}a

// Modifikasi publishBtn event listener
// ========== FUNGSI UNTUK KIRIM KE GOOGLE SHEETS ==========

// Fungsi utama untuk upload dataset
async function uploadToGoogleSheets(datasetData) {
  const { GOOGLE_SCRIPT_URL, API_KEY } = window.APP_CONFIG || {};
  
  if (!GOOGLE_SCRIPT_URL || !API_KEY) {
    console.error('Google Script URL atau API Key belum diatur di lib/config.js');
    return null;
  }
  
  try {
    const payload = {
      method: 'addDataset',
      api_key: API_KEY,
      ...datasetData
    };
    
    console.log('Mengirim data ke Google Sheets:', payload);
    
    // Kirim ke Google Apps Script
    const response = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors', // Penting untuk Google Apps Script
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload)
    });
    
    // Karena no-cors, kita tidak bisa membaca response
    // Tapi kita anggap sukses jika tidak ada error
    return { success: true, message: 'Data terkirim ke Google Sheets' };
    
  } catch (error) {
    console.error('Error mengirim ke Google Sheets:', error);
    throw error;
  }
}

// Fungsi untuk upload file ke Google Drive (manual)
function uploadFileToDriveManual(file) {
  return new Promise((resolve, reject) => {
    const instructions = `
ðŸ“ **UPLOAD FILE KE GOOGLE DRIVE**

Langkah-langkah:
1. Buka drive.google.com
2. Upload file: "${file.name}"
3. Klik kanan file â†’ "Dapatkan link"
4. Setel akses: "Anyone with the link" â†’ "Viewer"
5. Salin link dan tempel di popup berikut

Catatan: File akan tersimpan di Google Drive.
    `;
    
    alert(instructions);
    
    const driveLink = prompt('ðŸ“‹ Tempel Google Drive link di sini:', '');
    
    if (driveLink) {
      // Konversi share link ke direct download link
      let directLink = driveLink;
      
      // Pattern 1: https://drive.google.com/file/d/FILE_ID/view
      const pattern1 = /\/d\/([a-zA-Z0-9_-]+)/;
      // Pattern 2: https://drive.google.com/open?id=FILE_ID
      const pattern2 = /id=([a-zA-Z0-9_-]+)/;
      
      if (pattern1.test(driveLink)) {
        const fileId = driveLink.match(pattern1)[1];
        directLink = `https://drive.google.com/uc?export=download&id=${fileId}`;
      } else if (pattern2.test(driveLink)) {
        const fileId = driveLink.match(pattern2)[1];
        directLink = `https://drive.google.com/uc?export=download&id=${fileId}`;
      }
      
      resolve({
        share_link: driveLink,
        direct_link: directLink,
        filename: file.name,
        size: file.size
      });
    } else {
      reject(new Error('User membatalkan upload'));
    }
  });
}

// Fungsi untuk simpan ke localStorage (backup)
function saveToLocalBackup(dataset) {
  try {
    const localData = JSON.parse(localStorage.getItem('local_datasets') || '[]');
    
    // Tambah ID unik jika belum ada
    if (!dataset.id) {
      dataset.id = 'local-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    }
    
    dataset.local_backup = true;
    dataset.local_save_date = new Date().toISOString();
    
    localData.push(dataset);
    localStorage.setItem('local_datasets', JSON.stringify(localData));
    
    console.log('Data disimpan ke localStorage backup:', dataset);
    return dataset.id;
  } catch (error) {
    console.error('Gagal simpan ke localStorage:', error);
    return null;
  }
}

// Fungsi untuk ambil data dari tabel
function getTableData() {
  const headers = Array.from(tableHeader.querySelectorAll('th'))
    .map(th => th.textContent.trim())
    .filter(h => h && h !== 'Data akan muncul di sini setelah upload...');
  
  const rows = Array.from(tableBody.querySelectorAll('tr'))
    .map(tr => Array.from(tr.querySelectorAll('td'))
      .map(td => td.textContent.trim())
    )
    .filter(row => row.length > 0);
  
  return {
    headers: headers.length > 0 ? headers : null,
    rows: rows.length > 0 ? rows : null,
    totalRows: rows.length
  };
}

// ========== EVENT LISTENER PUBLISH BUTTON ==========

publishBtn.addEventListener('click', async function() {
  // 1. Validasi input
  const title = datasetTitle.value.trim();
  const description = datasetDesc.value.trim();
  const category = datasetCategory.value;
  const year = datasetYear.value;
  const selectedFile = fileInput.files[0];
  
  if (!title) {
    alert('âŒ Judul dataset wajib diisi!');
    datasetTitle.focus();
    return;
  }
  
  // 2. Ambil data dari tabel
  const tableData = getTableData();
  
  if (!selectedFile && (!tableData.headers || tableData.totalRows === 0)) {
    alert('âŒ Tidak ada data untuk dipublikasikan!\nMohon upload file atau input data di tabel.');
    return;
  }
  
  // 3. Siapkan data untuk dikirim
  const dataset = {
    id: 'ds-' + Date.now(),
    title: title,
    description: description,
    category: category,
    year: year,
    format: selectedFile ? selectedFile.name.split('.').pop().toUpperCase() : 'CSV',
    rows: tableData.totalRows,
    owner: localStorage.getItem('pd_display') || 'Unknown User',
    upload_date: new Date().toISOString(),
    status: 'pending',
    preview_data: tableData.headers ? [tableData.headers, ...tableData.rows] : null
  };
  
  // 4. Jika ada file, upload ke Google Drive
  if (selectedFile) {
    try {
      alert('ðŸ”„ Mengupload file ke Google Drive...');
      const driveResult = await uploadFileToDriveManual(selectedFile);
      
      dataset.file_url = driveResult.direct_link;
      dataset.share_url = driveResult.share_link;
      dataset.original_filename = selectedFile.name;
      dataset.file_size = selectedFile.size;
      dataset.format = selectedFile.name.split('.').pop().toUpperCase();
      
    } catch (error) {
      console.warn('File upload dibatalkan atau gagal:', error);
      // Lanjut tanpa file URL
    }
  }
  
  // 5. Kirim ke Google Sheets
  try {
    alert('ðŸ“¤ Mengirim metadata ke Google Sheets...');
    const sheetsResult = await uploadToGoogleSheets(dataset);
    
    if (sheetsResult && sheetsResult.success) {
      // 6. Simpan backup ke localStorage
      const localId = saveToLocalBackup(dataset);
      
      // 7. Tampilkan konfirmasi sukses
      const successMessage = `
âœ… **DATASET BERHASIL DIPUBLIKASIKAN!**

Judul: ${title}
Kategori: ${category}
Tahun: ${year}
ID: ${dataset.id}

Data telah disimpan ke:
â€¢ Google Sheets (metadata)
â€¢ Google Drive (file)${selectedFile ? ' âœ“' : ''}
â€¢ Local Storage (backup) âœ“

Data akan muncul di katalog dalam beberapa detik.
      `;
      
      alert(successMessage);
      
      // 8. Reset form
      clearTable();
      datasetTitle.value = '';
      datasetDesc.value = '';
      fileInput.value = '';
      
      // 9. Redirect ke katalog setelah delay
      setTimeout(() => {
        window.location.href = `katalog.html?added=${encodeURIComponent(dataset.id)}`;
      }, 2000);
      
    } else {
      throw new Error('Gagal mengirim ke Google Sheets');
    }
    
  } catch (error) {
    console.error('Publish failed:', error);
    
    // Fallback: Simpan hanya di localStorage
    const localId = saveToLocalBackup(dataset);
    
    const fallbackMessage = `
âš ï¸ **GOOGLE SHEETS OFFLINE - DISIMPAN LOKAL**

Data berhasil disimpan di browser (localStorage):
ID: ${localId}

Catatan: Data hanya tersimpan di browser ini.
Untuk sinkronisasi ke Google Sheets, coba lagi nanti.
    `;
    
    alert(fallbackMessage);
    
    // Reset form
    clearTable();
    datasetTitle.value = '';
    datasetDesc.value = '';
    
    // Redirect ke katalog
    setTimeout(() => {
      window.location.href = `katalog.html?added=${encodeURIComponent(localId)}`;
    }, 1500);
  }
});

// ========== EKSPOR KE EXCEL (OPTIONAL) ==========

// Tambahkan button export di sidebar
const exportBtn = document.createElement('button');
exportBtn.innerHTML = '<i class="fas fa-file-excel mr-2"></i> Export to Excel';
exportBtn.className = 'mt-4 w-full bg-emerald-600 text-white py-3 px-4 rounded-xl text-sm font-bold hover:bg-emerald-700 transition flex items-center justify-center';
exportBtn.onclick = function() {
  const tableData = getTableData();
  
  if (!tableData.headers || tableData.totalRows === 0) {
    alert('Tidak ada data untuk diexport');
    return;
  }
  
  // Buat workbook
  const wb = XLSX.utils.book_new();
  
  // Siapkan data untuk Excel
  const excelData = tableData.headers ? [tableData.headers, ...tableData.rows] : [];
  const ws = XLSX.utils.aoa_to_sheet(excelData);
  
  // Tambah ke workbook
  XLSX.utils.book_append_sheet(wb, ws, 'Dataset');
  
  // Generate filename
  const title = datasetTitle.value.trim() || 'dataset_export';
  const date = new Date().toISOString().split('T')[0];
  const filename = `${title}_${date}.xlsx`;
  
  // Export
  XLSX.writeFile(wb, filename);
  
  alert(`âœ… Data berhasil diexport ke ${filename}`);
};

// Tambahkan button ke sidebar
const sidebar = document.querySelector('.lg\\:col-span-1');
if (sidebar) {
  sidebar.appendChild(exportBtn);
}
    </script>
</body>
</html>